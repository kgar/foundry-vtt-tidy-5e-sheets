<script lang="ts">
  import { CONSTANTS } from 'src/constants';
  import { getExhaustionIconsWithSeverity } from 'src/features/exhaustion/exhaustion';
  import type {
    SpecificExhaustionConfig,
    IconWithSeverity,
  } from 'src/features/exhaustion/exhaustion.types';
  import { FoundryAdapter } from 'src/foundry/foundry-adapter';
  import type {
    ActorSheetContextV1,
    PortraitCharmRadiusClass,
  } from 'src/types/types';
  import { createEventDispatcher, getContext } from 'svelte';
  import type { Readable } from 'svelte/store';

  export let cssClass: string = '';
  export let radiusClass: PortraitCharmRadiusClass;
  export let level: number;
  export let onlyShowOnHover: boolean = false;
  export let exhaustionConfig: SpecificExhaustionConfig;
  export let isActiveEffectApplied: boolean;

  let iconsWithSeverities: IconWithSeverity[];
  $: {
    iconsWithSeverities = getExhaustionIconsWithSeverity(
      exhaustionConfig.levels,
    );
  }

  let selectedLevel: IconWithSeverity;
  let selectedHintKey: string;
  $: {
    selectedLevel = iconsWithSeverities[level] ?? iconsWithSeverities.at(-1);
    selectedHintKey = exhaustionConfig.hints[level] ?? '';
  }

  let severityClass: string;
  $: {
    severityClass = `severity-${selectedLevel?.severity ?? 0}`;
  }

  const localize = FoundryAdapter.localize;

  let context = getContext<Readable<ActorSheetContextV1>>(
    CONSTANTS.SVELTE_CONTEXT.CONTEXT,
  );

  const dispatch = createEventDispatcher<{
    levelSelected: { level: number };
  }>();

  let exhaustionOptionWidthRems = 1.5;
  $: exhaustionExpandedWidth = `${
    exhaustionOptionWidthRems * (exhaustionConfig.levels + 1) + 2.125
  }rem`;

  $: disabled = !$context.editable || isActiveEffectApplied;
</script>

<div
  class="exhaustion-container {severityClass} {cssClass}"
  class:only-show-on-hover={onlyShowOnHover}
  style="--t5e-exhaustion-expanded-width: {exhaustionExpandedWidth}"
>
  <div class="exhaustion-wrap {radiusClass}">
    <div
      class="exhaustion-icon colorized"
      title={`${localize('DND5E.Exhaustion')} ${localize(
        'DND5E.AbbreviationLevel',
      )} ${level}, ${localize(selectedHintKey)}`}
    >
      <i class={selectedLevel.iconCssClass ?? ''} />
    </div>
    <ul class="exhaustion-levels">
      {#each iconsWithSeverities as _, i}
        <li>
          {#if !disabled}
            <!-- svelte-ignore a11y-missing-attribute -->
            <!-- svelte-ignore a11y-click-events-have-key-events -->
            <!-- svelte-ignore a11y-no-static-element-interactions -->
            <a
              class="exhaustion-level-option transparent-button"
              class:colorized={i <= level}
              title={localize(exhaustionConfig.hints[i] ?? '')}
              on:click={() => dispatch('levelSelected', { level: i })}
              data-tooltip={isActiveEffectApplied
                ? localize('DND5E.ActiveEffectOverrideWarning')
                : null}
            >
              {i}
            </a>
          {:else}
            <span
              class="exhaustion-level-option transparent-button"
              class:colorized={i <= level}
            >
              {i}
            </span>
          {/if}
        </li>
      {/each}
    </ul>
  </div>
  <div class="level-display" class:colorized={level > 0}>
    {level}
  </div>
</div>

<style lang="scss">
  .exhaustion-container {
    position: absolute;
    top: 0;
    left: 0;
    height: 2.125rem;
    width: 2.125rem;
    z-index: 1;
    color: var(--t5e-icon-font-color);

    .level-display {
      display: block;
      width: 1rem;
      height: 1rem;
      line-height: 0.875rem;
      text-align: center;
      font-size: 0.875rem;
      position: absolute;
      background: var(--t5e-icon-background);
      box-shadow: 0 0 0.5rem var(--t5e-icon-shadow-color) inset;
      border: 0.0625rem solid var(--t5e-icon-outline-color);
      top: -0.125rem;
      left: -0.125rem;
      border-radius: 50%;
      font-weight: 700;
    }

    &:hover .exhaustion-wrap,
    .exhaustion-wrap:has(.exhaustion-level-option:focus-visible) {
      width: var(--t5e-exhaustion-expanded-width);
    }

    .exhaustion-wrap {
      height: 2.125rem;
      width: 2.125rem;
      overflow: hidden;
      transition: width 0.3s ease;
      background: var(--t5e-icon-background);
      display: flex;
      box-shadow: 0 0 0.625rem var(--t5e-icon-shadow-color) inset;
      border: 0.0625rem solid var(--t5e-icon-outline-color);

      &.rounded {
        border-radius: 1.25rem;
      }

      .exhaustion-icon {
        display: block;
        flex: 0 0 2rem;
        width: 2rem;
        height: 2rem;
        line-height: 2.125rem;
        text-align: center;
        font-size: 1.5rem;
        position: relative;
      }

      .exhaustion-levels {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex: 1;

        li {
          flex: 0 0 1.5rem;
          text-align: center;
          line-height: 2.125rem;
          display: flex;

          .exhaustion-level-option {
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;

            &:is(:hover, :focus-visible) {
              background: var(--t5e-tertiary-color);
              color: var(--t5e-primary-font-color);
            }
          }
        }
      }
    }

    .exhaustion-levels .exhaustion-level-option:not(.colorized) {
      background: var(--t5e-light-color);
    }

    &.severity-0 .colorized {
      background: transparent;
    }

    &.severity-1 .colorized {
      background: var(--t5e-exhaustion-severity1-background);
      color: var(--t5e-exhaustion-severity1-color);
    }

    &.severity-2 .colorized {
      background: var(--t5e-exhaustion-severity2-background);
      color: var(--t5e-exhaustion-severity2-color);
    }

    &.severity-3 .colorized {
      background: var(--t5e-exhaustion-severity3-background);
      color: var(--t5e-exhaustion-severity3-color);
    }
  }
</style>
